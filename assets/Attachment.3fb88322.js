import{t as p}from"./tableFlow.31edb31e.js";import{d as g}from"./datePicker.1a087a29.js";import{n as r,o}from"./index.621e7bf7.js";var d={mixins:[g],props:{value:{type:Boolean,default:!1},type:{type:String,default:"add"},data:{type:Object}},computed:{visible:{get(){return this.value},set(e){this.$emit("input",e)}}},data(){return{title:"",span:20,defaultForm:{},defaultQuery:{},form:{},query:{},selectItem:{},queryLoading:!1,saveLoading:!1}},mounted(){this.defaultForm=JSON.parse(JSON.stringify(this.form)),this.defaultQuery=JSON.parse(JSON.stringify(this.query))},methods:{resetForm(){this.form=Object.assign({},this.defaultForm)},resetQuery(){this.query=Object.assign({},this.defaultQuery)}}},f=function(){var e=this,t=this,i=t.$createElement,a=t._self._c||i;return a("k-drawer",{attrs:{visible:t.visible,title:t.title,size:"45%","destroy-on-close":""},on:{"update:visible":function(s){t.visible=s},fullscreen:function(s){e.span=s?12:20},closed:function(s){t.resetForm(),t.showAllTag=!1}},scopedSlots:t._u([{key:"footer",fn:function(){return[a("el-button",{attrs:{size:"small"},on:{click:function(s){t.visible=!1}}},[t._v("\u53D6\u6D88")]),a("el-button",{directives:[{name:"throttle",rawName:"v-throttle"}],attrs:{size:"small",type:"primary",loading:t.saveLoading},on:{click:function(s){t.type==="edit"?t.updateImage():t.createImage()}}},[t._v("\u4FDD\u5B58")])]},proxy:!0}])},[a("el-row",{directives:[{name:"loading",rawName:"v-loading",value:t.queryLoading,expression:"queryLoading"}],attrs:{type:"flex",justify:"center"}},[a("el-col",{attrs:{span:t.span}},[a("el-form",{ref:"form",attrs:{model:t.form,rules:t.rules,"label-width":"80px",size:"small"},nativeOn:{submit:function(s){s.preventDefault()}}},[a("el-form-item",{attrs:{label:"\u6807\u7B7E"}},[a("div",{staticStyle:{display:"flex","flex-flow":"row wrap","align-items":"center"}},[a("el-select",{attrs:{multiple:"",clearable:"",filterable:""},on:{change:t.syncTagSelect},model:{value:t.form.tag,callback:function(s){t.$set(t.form,"tag",s)},expression:"form.tag"}},t._l(t.tagList,function(s,l){return a("el-option",{key:l,attrs:{label:s.tag_name,value:s.id}},[a("div",{staticStyle:{display:"flex","flex-flow":"row nowrap","justify-content":"space-between","align-items":"center"}},[a("span",[t._v(t._s(s.tag_name))]),a("span",{staticClass:"el-icon-circle-close",staticStyle:{color:"#8492a6","font-size":"13px","vertical-align":"middle"},on:{click:function(n){return n.stopPropagation(),t.deleteTag(s)}}})])])}),1),t.inputVisible?a("el-input",{ref:"saveTagInput",staticClass:"input-new-tag",staticStyle:{width:"90px"},attrs:{size:"small"},on:{blur:t.addTag},nativeOn:{keyup:function(s){return!s.type.indexOf("key")&&t._k(s.keyCode,"enter",13,s.key,"Enter")?null:t.addTag.apply(null,arguments)}},model:{value:t.inputValue,callback:function(s){t.inputValue=s},expression:"inputValue"}}):a("el-button",{staticClass:"button-new-tag",attrs:{size:"mini"},on:{click:t.showInput}},[t._v("+ New Tag")]),a("el-button",{attrs:{size:"mini"},on:{click:function(s){t.showAllTag=!t.showAllTag}}},[t._v(t._s(t.showAllTag?"\u5173\u95ED\u5168\u90E8":"\u5C55\u5F00\u5168\u90E8"))])],1),a("transition",{attrs:{name:"fade"}},[t.showAllTag?a("div",{staticClass:"all-tag",staticStyle:{display:"flex","flex-flow":"row wrap","align-items":"center",gap:"10px","margin-top":"10px"}},t._l(t.tagList,function(s,l){return a("el-tag",{key:l,attrs:{closable:"",effect:s.select?"dark":"plain"},on:{close:function(n){return t.deleteTag(s)},click:function(n){return t.selcetTag(s,l)}}},[t._v(" "+t._s(s.tag_name)+" ")])}),1):t._e()])],1),a("el-form-item",{attrs:{label:"\u7C7B\u522B"}},[a("el-select",{model:{value:t.form.business_type,callback:function(s){t.$set(t.form,"business_type",s)},expression:"form.business_type"}},t._l(t.$dict.pictureType,function(s,l){return a("el-option",{key:l,attrs:{label:s.label,value:s.value}})}),1)],1),t.type==="add"?a("el-form-item",{attrs:{label:"\u4E0A\u4F20\u56FE\u7247",prop:"file"}},[a("k-upload-image",{ref:"upload",attrs:{accept:"image/jpeg,image/png","is-cropper":!1,upload:t.upload},on:{delete:function(){e.form.file=null}},scopedSlots:t._u([{key:"tip",fn:function(){return[a("div",[t._v("\u53EA\u80FD\u4E0A\u4F20jpg,png,gif\u6587\u4EF6\uFF0C\u4E14\u4E0D\u8D85\u8FC72M")])]},proxy:!0}],null,!1,1849799124)})],1):t._e(),a("el-form-item",{attrs:{label:"\u56FE\u7247\u540D\u79F0"}},[a("el-input",{model:{value:t.form.att_name,callback:function(s){t.$set(t.form,"att_name",s)},expression:"form.att_name"}})],1)],1)],1)],1)],1)},h=[];const y={name:"AddEditPicture",mixins:[d],data(){return{form:{att_name:"",business_type:1,tag:[],file:null},rules:{file:[{required:!0,message:"\u8BF7\u9009\u62E9\u6587\u4EF6",trigger:"blur"}]},tagList:[],inputVisible:!1,inputValue:"",showAllTag:!1}},watch:{async value(e,t){e?(this.type==="add"?this.title="\u65B0\u589E\u56FE\u7247":this.type==="edit"&&(this.title="\u7F16\u8F91\u56FE\u7247",await this.getPictureInfo()),this.getTagAll()):this.resetForm()}},methods:{async getPictureInfo(){this.queryLoading=!0;let t=(await this.$api.picture.query(this.data.id)).data;this.$libs.getAssignKeyData(this.form,t),this.queryLoading=!1},async syncTagSelect(){for(let e of this.tagList){let t=this.form.tag.findIndex(i=>i===e.id);e.select=t>=0}},async getTagAll(){let e=await this.$api.tag.queryAll({type:"1"});this.tagList=e.data,this.syncTagSelect()},async selcetTag(e,t){if(e.select=!e.select,this.$set(this.tagList,t,e),e.select)this.form.tag.push(e.id);else{let i=this.form.tag.findIndex(a=>a===e.id);this.form.tag.splice(i,1)}},async showInput(){this.inputVisible=!0,this.$nextTick(e=>{this.$refs.saveTagInput.$refs.input.focus()})},async addTag(){let e=this.inputValue;if(e){this.queryLoading=!0;let t={tag_name:e,type:1};try{let i=await this.$api.tag.create(t);this.tagList.unshift(i.data),this.$message.success(e+"\u6DFB\u52A0\u6210\u529F")}catch{}finally{this.queryLoading=!1}}this.inputVisible=!1,this.inputValue="",this.queryLoading=!1},async deleteTag(e){this.$tool.confirmWarning("\u786E\u5B9A\u8981\u5220\u9664 "+e.tag_name+"\u6807\u7B7E\u5417\uFF1F").then(async()=>{this.queryLoading=!0;try{await this.$api.tag.delete({id:e.id});let t=this.tagList.findIndex(i=>i.id===e.id);this.tagList.splice(t,1),this.$message.success(e.tag_name+"\u5220\u9664\u6210\u529F")}catch{}finally{this.queryLoading=!1}}).catch(t=>{})},async upload(e){if(e.size/1024/1024>2){this.$message.warning("\u6587\u4EF6\u4E0D\u80FD\u8D85\u8FC72M");return}this.form.file=e,this.form.att_name=e.name},async createImage(){let e;if(this.$refs.form.validate(a=>{e=a}),!e)return;this.saveLoading=!0;let t=Object.assign({},this.form),i="";try{const a=new Blob([t.file],{type:t.file.type});new FormData().append("file",a,t.file.name);let l=await o.imagePutSignedUrl({mime:t.file.type,picture_type:this.form.business_type}),n=l.data.url;await o.putObject(n,a,{headers:{"Content-Type":t.file.type}}),i=l.data.path}catch{this.$message.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25");return}finally{this.saveLoading=!1}console.log(i);try{t.file=i,console.log(t);let a=this.$libs.formatFormData(t);console.log(a.file);let s=await this.$api.picture.create(a);this.$emit("success",this.type,s.data),this.visible=!1,this.$message.success("\u65B0\u589E\u6210\u529F")}catch(a){console.log(a)}finally{this.saveLoading=!1}},async updateImage(){this.saveLoading=!0;let e=Object.assign({},this.form);e.id=this.data.id;try{let t=await this.$api.picture.update(e);this.$emit("success",this.type,e),this.visible=!1,this.$message.success("\u66F4\u65B0\u6210\u529F")}catch{}finally{this.saveLoading=!1}}}},c={};var m=r(y,f,h,!1,v,"0094e29d",null,null);function v(e){for(let t in c)this[t]=c[t]}var _=function(){return m.exports}(),b=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("el-row",[i("el-col",{staticStyle:{"margin-bottom":"20px"},attrs:{span:24}},[i("div",{staticStyle:{display:"flex","flex-flow":"row nowrap","justify-content":"space-between","align-items":"center"}},[i("div",{staticStyle:{display:"flex","flex-flow":"row nowrap","align-items":"center",gap:"10px"}},[i("span",[e._v("\u9009\u62E9\u6807\u7B7E")]),i("el-select",{attrs:{size:"mini",multiple:"",clearable:"",filterable:"","collapse-tags":""},on:{change:e.syncTagSelect},model:{value:e.query.tag,callback:function(a){e.$set(e.query,"tag",a)},expression:"query.tag"}},e._l(e.tagList,function(a,s){return i("el-option",{key:s,attrs:{label:a.tag_name,value:a.id}})}),1),i("el-button",{attrs:{size:"mini",plain:""},on:{click:function(a){e.showAllTag=!e.showAllTag}}},[e._v(e._s(e.showAllTag?"\u5173\u95ED\u5168\u90E8":"\u5C55\u5F00\u5168\u90E8"))])],1),i("div",{staticStyle:{display:"flex","flex-flow":"row nowrap","align-items":"center"}},[i("el-form",{attrs:{inline:""}},[i("el-form-item",{attrs:{label:"\u9009\u62E9\u7C7B\u522B",size:"small"}},[i("el-select",{staticStyle:{width:"100px"},model:{value:e.query.type,callback:function(a){e.$set(e.query,"type",a)},expression:"query.type"}},e._l(e.$dict.pictureType,function(a,s){return i("el-option",{key:s,attrs:{label:a.label,value:a.value}})}),1)],1)],1),i("el-button",{directives:[{name:"throttle",rawName:"v-throttle"}],attrs:{icon:"el-icon-search",size:"small",type:"primary",loading:e.queryLoading},on:{click:function(a){return e.getPictureList()}}},[e._v("\u67E5\u8BE2")]),i("el-button",{directives:[{name:"throttle",rawName:"v-throttle"}],attrs:{icon:"el-icon-refresh",size:"small",plain:"",type:"",loading:e.queryLoading},on:{click:function(a){e.resetQuery(),e.getPictureList()}}},[e._v("\u91CD\u7F6E ")]),i("el-button",{attrs:{icon:"el-icon-plus",size:"small",type:"primary"},on:{click:function(a){e.drawer.visible=!0}}},[e._v("\u65B0\u589E\u56FE\u7247")])],1)]),i("transition",{attrs:{name:"fade"}},[e.showAllTag?i("div",{staticClass:"all-tag",staticStyle:{display:"flex","flex-flow":"row wrap","align-items":"center",gap:"10px","margin-top":"10px"}},e._l(e.tagList,function(a,s){return i("el-tag",{key:s,attrs:{effect:a.select?"dark":"plain"},on:{click:function(l){return e.selcetTag(a,s)}}},[e._v(e._s(a.tag_name)+" ")])}),1):e._e()])],1),i("el-col",{attrs:{span:24}},[i("el-row",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{"flex-wrap":"wrap"},attrs:{type:"flex",justify:"center"}},e._l(e.data,function(a,s){return i("el-col",{key:s,staticClass:"item-image",attrs:{xs:8,sm:6,md:4,lg:3,xl:4},nativeOn:{click:function(l){e.$emit("select",Object.assign({},a)),e.show=!1}}},[i("el-image",{staticStyle:{width:"100%",height:"100%","margin-bottom":"5px"},attrs:{src:e.$config.staticUrl()+a.path,lazy:"",fit:"contain"}},[i("div",{staticClass:"image-slot",attrs:{slot:"placeholder"},slot:"placeholder"},[i("span",[e._v("\u52A0\u8F7D\u4E2D"),i("span",{staticClass:"dot"},[e._v("...")])])])]),i("span",[e._v(e._s(a.att_name))])],1)}),1)],1),i("el-col",{attrs:{span:24}},[i("div",{staticStyle:{display:"flex","flex-flow":"row nowrap","justify-content":"flex-end","margin-top":"20px"}},[i("el-pagination",{attrs:{background:"",layout:"prev, pager, next,sizes",total:e.total,"current-page":e.pagination.currentPage,"page-size":e.pagination.limit,"page-sizes":e.pagination.pageSizes},on:{"update:currentPage":function(a){return e.$set(e.pagination,"currentPage",a)},"update:current-page":function(a){return e.$set(e.pagination,"currentPage",a)},"update:pageSize":function(a){return e.$set(e.pagination,"limit",a)},"update:page-size":function(a){return e.$set(e.pagination,"limit",a)},"update:pageSizes":function(a){return e.$set(e.pagination,"pageSizes",a)},"update:page-sizes":function(a){return e.$set(e.pagination,"pageSizes",a)},"size-change":function(a){return e.getPictureList()},"current-change":function(a){return e.getPictureList()}}})],1)]),i("add-edit-picture",{attrs:{type:"add"},on:{success:e.handleAction},model:{value:e.drawer.visible,callback:function(a){e.$set(e.drawer,"visible",a)},expression:"drawer.visible"}})],1)},w=[];const x={name:"Attachment",components:{AddEditPicture:_},mixins:[p],props:{visible:{type:Boolean}},computed:{show:{get(){return this.visible},set(e){this.$emit("update:visible",e)}}},data(){return{showAllTag:!1,data:[],query:{type:null,tag:[]},tagList:[],pagination:{layout:"prev, pager, next, total,sizes, jumper",limit:20,currentPage:1,pageSizes:[10,20,30,40,50]}}},mounted(){this.getTagAll(),this.getPictureList()},methods:{handleAction(e,t=null){e==="add"&&this.data.unshift(t)},async getPictureList(){this.queryLoading=!0,this.loading=!0;let e={page:this.pagination.currentPage?this.pagination.currentPage:1,limit:this.pagination.limit?this.pagination.limit:10},t=Object.assign(e,this.$libs.filterNullObject(this.query));try{let i=await this.$api.picture.batchQuery(t);this.data=i.data.data,this.total=i.data.total}catch{}finally{this.queryLoading=!1,this.loading=!1}},async getTagAll(){let e=await this.$api.tag.queryAll({type:1});this.tagList=e.data},async selcetTag(e,t){if(e.select=!e.select,this.$set(this.tagList,t,e),e.select)this.query.tag.push(e.id);else{let i=this.query.tag.findIndex(a=>a===e.id);this.query.tag.splice(i,1)}},async syncTagSelect(){for(let e of this.tagList){let t=this.query.tag.findIndex(i=>i===e.id);e.select=t>=0}},async resetQuery(){this.query=JSON.parse(JSON.stringify(this.defaultQuery)),this.syncTagSelect()}}},u={};var $=r(x,b,w,!1,L,"35e322e8",null,null);function L(e){for(let t in u)this[t]=u[t]}var q=function(){return $.exports}();export{q as A,_ as a,d};
